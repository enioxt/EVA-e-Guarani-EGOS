#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "${YELLOW}ğŸ”„ Verificando atualizaÃ§Ãµes apÃ³s merge...${NC}"

# Verifica se package.json foi modificado
if git diff HEAD@{1} --name-only | grep -q "package.json"; then
  echo "${YELLOW}ğŸ“¦ package.json foi modificado. Instalando dependÃªncias...${NC}"
  npm install || {
    echo "${RED}âŒ Erro ao instalar dependÃªncias.${NC}"
    exit 1
  }
fi

# Verifica se .env.example foi modificado
if git diff HEAD@{1} --name-only | grep -q ".env.example"; then
  echo "${YELLOW}âš™ï¸ .env.example foi modificado. Verifique se precisa atualizar seu .env${NC}"
fi

# Verifica se hÃ¡ migraÃ§Ãµes pendentes
if git diff HEAD@{1} --name-only | grep -q "migrations/"; then
  echo "${YELLOW}ğŸ”„ Detectadas novas migraÃ§Ãµes. Execute 'npm run migrate' se necessÃ¡rio.${NC}"
fi

# Verifica se houve mudanÃ§as nos testes
if git diff HEAD@{1} --name-only | grep -q "test"; then
  echo "${YELLOW}ğŸ§ª Detectadas mudanÃ§as nos testes. Executando suite de testes...${NC}"
  npm run test || {
    echo "${RED}âŒ Testes falharam apÃ³s merge.${NC}"
    exit 1
  }
fi

# Limpa cache e arquivos de build
echo "${YELLOW}ğŸ§¹ Limpando cache...${NC}"
npm run clean || {
  echo "${RED}âŒ Erro ao limpar cache.${NC}"
  exit 1
}

# ReconstrÃ³i o projeto
echo "${YELLOW}ğŸ—ï¸ Reconstruindo o projeto...${NC}"
npm run build || {
  echo "${RED}âŒ Build falhou apÃ³s merge.${NC}"
  exit 1
}

echo "${GREEN}âœ… Merge finalizado com sucesso!${NC}" 