#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ParÃ¢metros do post-checkout hook
previousHead=$1
newHead=$2
checkoutType=$3

echo "${YELLOW}ğŸ”„ Verificando atualizaÃ§Ãµes apÃ³s checkout...${NC}"

# Se for uma mudanÃ§a de branch (checkoutType=1)
if [ "$checkoutType" = 1 ]; then
  # Verifica se package.json foi modificado
  if git diff "$previousHead" "$newHead" --name-only | grep -q "package.json"; then
    echo "${YELLOW}ğŸ“¦ package.json foi modificado. Instalando dependÃªncias...${NC}"
    npm install || {
      echo "${RED}âŒ Erro ao instalar dependÃªncias.${NC}"
      exit 1
    }
  fi

  # Verifica se .env.example foi modificado
  if git diff "$previousHead" "$newHead" --name-only | grep -q ".env.example"; then
    echo "${YELLOW}âš™ï¸ .env.example foi modificado. Verifique se precisa atualizar seu .env${NC}"
  fi

  # Verifica se hÃ¡ migraÃ§Ãµes pendentes
  if git diff "$previousHead" "$newHead" --name-only | grep -q "migrations/"; then
    echo "${YELLOW}ğŸ”„ Detectadas novas migraÃ§Ãµes. Execute 'npm run migrate' se necessÃ¡rio.${NC}"
  fi

  # Verifica se houve mudanÃ§as nos testes
  if git diff "$previousHead" "$newHead" --name-only | grep -q "test"; then
    echo "${YELLOW}ğŸ§ª Detectadas mudanÃ§as nos testes. Executando suite de testes...${NC}"
    npm run test || {
      echo "${RED}âŒ Testes falharam apÃ³s checkout.${NC}"
      exit 1
    }
  fi

  # Limpa cache e arquivos de build
  echo "${YELLOW}ğŸ§¹ Limpando cache...${NC}"
  npm run clean || {
    echo "${RED}âŒ Erro ao limpar cache.${NC}"
    exit 1
  }

  # ReconstrÃ³i o projeto
  echo "${YELLOW}ğŸ—ï¸ Reconstruindo o projeto...${NC}"
  npm run build || {
    echo "${RED}âŒ Build falhou apÃ³s checkout.${NC}"
    exit 1
  }
fi

echo "${GREEN}âœ… Checkout finalizado com sucesso!${NC}" 