#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "${YELLOW}🔄 Verificando atualizações após merge...${NC}"

# Verifica se package.json foi modificado
if git diff HEAD@{1} --name-only | grep -q "package.json"; then
  echo "${YELLOW}📦 package.json foi modificado. Instalando dependências...${NC}"
  npm install || {
    echo "${RED}❌ Erro ao instalar dependências.${NC}"
    exit 1
  }
fi

# Verifica se .env.example foi modificado
if git diff HEAD@{1} --name-only | grep -q ".env.example"; then
  echo "${YELLOW}⚙️ .env.example foi modificado. Verifique se precisa atualizar seu .env${NC}"
fi

# Verifica se há migrações pendentes
if git diff HEAD@{1} --name-only | grep -q "migrations/"; then
  echo "${YELLOW}🔄 Detectadas novas migrações. Execute 'npm run migrate' se necessário.${NC}"
fi

# Verifica se houve mudanças nos testes
if git diff HEAD@{1} --name-only | grep -q "test"; then
  echo "${YELLOW}🧪 Detectadas mudanças nos testes. Executando suite de testes...${NC}"
  npm run test || {
    echo "${RED}❌ Testes falharam após merge.${NC}"
    exit 1
  }
fi

# Limpa cache e arquivos de build
echo "${YELLOW}🧹 Limpando cache...${NC}"
npm run clean || {
  echo "${RED}❌ Erro ao limpar cache.${NC}"
  exit 1
}

# Reconstrói o projeto
echo "${YELLOW}🏗️ Reconstruindo o projeto...${NC}"
npm run build || {
  echo "${RED}❌ Build falhou após merge.${NC}"
  exit 1
}

echo "${GREEN}✅ Merge finalizado com sucesso!${NC}" 