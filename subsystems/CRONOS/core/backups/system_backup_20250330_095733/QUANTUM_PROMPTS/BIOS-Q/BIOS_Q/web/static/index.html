<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA & GUARANI - Dashboard</title>

    <!-- React and dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- D3.js for visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap">

    <style>
        :root {
            --primary: #8e44ad;
            --secondary: #3498db;
            --accent: #e74c3c;
            --background: #f9fafb;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --border: #ecf0f1;
            --success: #2ecc71;
            --warning: #f39c12;
            --error: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-left: 10px;
        }

        .logo-symbol {
            font-size: 1.4rem;
            color: var(--primary);
        }

        .version {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-left: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-operational {
            background-color: var(--success);
        }

        .status-partial {
            background-color: var(--warning);
        }

        .status-offline {
            background-color: var(--error);
        }

        .card-content {
            height: 100%;
        }

        .col-span-4 {
            grid-column: span 4;
        }

        .col-span-6 {
            grid-column: span 6;
        }

        .col-span-8 {
            grid-column: span 8;
        }

        .col-span-12 {
            grid-column: span 12;
        }

        .system-status {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text);
        }

        .visualization-container {
            height: 400px;
            position: relative;
        }

        .console {
            font-family: 'Courier New', Courier, monospace;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
        }

        .console-line {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .timestamp {
            color: #3498db;
        }

        .command {
            color: #2ecc71;
            font-weight: bold;
        }

        .response {
            color: #ecf0f1;
        }

        .error {
            color: #e74c3c;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input,
        select,
        button {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid var(--border);
            font-family: inherit;
            font-size: 1rem;
        }

        input {
            flex: 1;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #7d26a3;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .tab:hover:not(.active) {
            background-color: rgba(142, 68, 173, 0.05);
        }

        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px 0;
            color: var(--text-light);
            border-top: 1px solid var(--border);
        }

        .signature {
            color: var(--primary);
            font-weight: 600;
            margin-top: 5px;
        }

        @media (max-width: 1200px) {

            .col-span-4,
            .col-span-6,
            .col-span-8 {
                grid-column: span 12;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // Main App Component
        const App = () => {
            const [status, setStatus] = React.useState({
                overall_status: "Loading...",
                subsystems: {},
                stats: {},
                last_updated: ""
            });

            const [activeTab, setActiveTab] = React.useState('dashboard');
            const [searchQuery, setSearchQuery] = React.useState('');
            const [searchResults, setSearchResults] = React.useState([]);
            const [consoleMessages, setConsoleMessages] = React.useState([
                { type: 'command', content: 'initialize_system()', timestamp: '2025-03-26 12:00:00' },
                { type: 'response', content: 'System initialized. Mycelium network active.', timestamp: '2025-03-26 12:00:01' },
                { type: 'command', content: 'connect_subsystems()', timestamp: '2025-03-26 12:00:03' },
                { type: 'response', content: 'All subsystems connected. Ready for operations.', timestamp: '2025-03-26 12:00:05' }
            ]);

            // WebSocket for real-time updates
            React.useEffect(() => {
                let ws;
                const connectWebSocket = () => {
                    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${wsProtocol}//${window.location.host}/ws`;

                    ws = new WebSocket(wsUrl);

                    ws.onopen = () => {
                        console.log('WebSocket connection established');
                        ws.send(JSON.stringify({ type: 'status_update' }));

                        // Add console message
                        addConsoleMessage('command', 'establish_websocket_connection()', new Date());
                        addConsoleMessage('response', 'WebSocket connection established', new Date());
                    };

                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);

                        if (data.type === 'status_update') {
                            setStatus(data.status);
                        } else if (data.type === 'search_results') {
                            setSearchResults(data.results);
                            addConsoleMessage('response', `Received ${data.results.length} search results for query: "${data.query}"`, new Date());
                        } else if (data.type === 'error') {
                            addConsoleMessage('error', `Error: ${data.message}`, new Date());
                        }
                    };

                    ws.onclose = () => {
                        console.log('WebSocket connection closed. Reconnecting...');
                        addConsoleMessage('error', 'WebSocket connection closed. Reconnecting...', new Date());
                        setTimeout(connectWebSocket, 2000);
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        addConsoleMessage('error', `WebSocket error: ${error.message || 'Unknown error'}`, new Date());
                    };
                };

                // Initial fetch before WebSocket is established
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            setStatus(data.data);
                            addConsoleMessage('command', 'fetch_system_status()', new Date());
                            addConsoleMessage('response', `System status: ${data.data.overall_status}`, new Date());
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching status:', error);
                        addConsoleMessage('error', `Error fetching status: ${error.message}`, new Date());
                    });

                // Connect to WebSocket
                connectWebSocket();

                // Cleanup on unmount
                return () => {
                    if (ws) {
                        ws.close();
                    }
                };
            }, []);

            // Add a console message
            const addConsoleMessage = (type, content, timestamp) => {
                const formattedTime = new Date(timestamp).toLocaleTimeString();
                setConsoleMessages(prev => [
                    ...prev,
                    { type, content, timestamp: formattedTime }
                ].slice(-100)); // Keep only the last 100 messages
            };

            // Handle search
            const handleSearch = () => {
                if (!searchQuery.trim()) return;

                addConsoleMessage('command', `search("${searchQuery}")`, new Date());

                fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: searchQuery }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            setSearchResults(data.data);
                            addConsoleMessage('response', `Found ${data.data.length} results for "${searchQuery}"`, new Date());
                        } else {
                            addConsoleMessage('error', `Search error: ${data.error}`, new Date());
                        }
                    })
                    .catch(error => {
                        console.error('Error during search:', error);
                        addConsoleMessage('error', `Search error: ${error.message}`, new Date());
                    });
            };

            // Status indicator helpers
            const getStatusClass = (status) => {
                switch (status) {
                    case 'Operational': return 'status-operational';
                    case 'Partially Operational': return 'status-partial';
                    case 'Offline': return 'status-offline';
                    default: return 'status-partial';
                }
            };

            return (
                <div className="container">
                    <header className="header">
                        <div className="logo">
                            <span className="logo-symbol">✧༺❀༻∞</span>
                            <h1>EVA & GUARANI</h1>
                            <span className="version">v7.5</span>
                        </div>
                        <div>
                            Last updated: {status.last_updated || 'Unknown'}
                        </div>
                    </header>

                    <div className="tabs">
                        <div
                            className={`tab ${activeTab === 'dashboard' ? 'active' : ''}`}
                            onClick={() => setActiveTab('dashboard')}
                        >
                            Dashboard
                        </div>
                        <div
                            className={`tab ${activeTab === 'search' ? 'active' : ''}`}
                            onClick={() => setActiveTab('search')}
                        >
                            Quantum Search
                        </div>
                        <div
                            className={`tab ${activeTab === 'network' ? 'active' : ''}`}
                            onClick={() => setActiveTab('network')}
                        >
                            Mycelial Network
                        </div>
                        <div
                            className={`tab ${activeTab === 'console' ? 'active' : ''}`}
                            onClick={() => setActiveTab('console')}
                        >
                            Console
                        </div>
                    </div>

                    {activeTab === 'dashboard' && (
                        <div className="grid">
                            <div className="card col-span-4">
                                <div className="card-header">
                                    <h2 className="card-title">System Status</h2>
                                    <div>
                                        <span className={`status-indicator ${getStatusClass(status.overall_status)}`}></span>
                                        {status.overall_status}
                                    </div>
                                </div>
                                <div className="card-content system-status">
                                    {status.subsystems && Object.entries(status.subsystems).map(([name, info]) => (
                                        <div className="status-row" key={name}>
                                            <div>{name}</div>
                                            <div>
                                                <span className={`status-indicator ${info.online ? 'status-operational' : 'status-offline'}`}></span>
                                                {info.status}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="card col-span-8">
                                <div className="card-header">
                                    <h2 className="card-title">Mycelial Network Visualization</h2>
                                </div>
                                <div className="card-content visualization-container">
                                    <MycelialNetworkVisualization />
                                </div>
                            </div>

                            <div className="card col-span-4">
                                <div className="card-header">
                                    <h2 className="card-title">System Statistics</h2>
                                </div>
                                <div className="card-content">
                                    <div className="stats-grid">
                                        {status.stats && Object.entries(status.stats).map(([key, value]) => (
                                            <div className="stat-item" key={key}>
                                                <div className="stat-label">{key}</div>
                                                <div className="stat-value">{value}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="card col-span-8">
                                <div className="card-header">
                                    <h2 className="card-title">Recent Activity</h2>
                                </div>
                                <div className="card-content">
                                    <div className="console">
                                        {consoleMessages.map((msg, index) => (
                                            <div className="console-line" key={index}>
                                                <span className="timestamp">[{msg.timestamp}]</span>
                                                {msg.type === 'command' && <span className="command"> $ {msg.content}</span>}
                                                {msg.type === 'response' && <span className="response"> {msg.content}</span>}
                                                {msg.type === 'error' && <span className="error"> ! {msg.content}</span>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'search' && (
                        <div className="grid">
                            <div className="card col-span-12">
                                <div className="card-header">
                                    <h2 className="card-title">Quantum Search</h2>
                                </div>
                                <div className="card-content">
                                    <div className="search-box">
                                        <input
                                            type="text"
                                            placeholder="Enter your search query..."
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                                        />
                                        <button onClick={handleSearch}>Search</button>
                                    </div>

                                    <div className="search-results">
                                        {searchResults.length > 0 ? (
                                            searchResults.map((result, index) => (
                                                <div className="card" key={index} style={{ marginBottom: '10px' }}>
                                                    <h3>{result.title || 'Untitled'}</h3>
                                                    <p>{result.snippet || 'No description available.'}</p>
                                                    <div>Score: {result.score?.toFixed(2) || 'N/A'}</div>
                                                </div>
                                            ))
                                        ) : (
                                            <p>No search results to display. Try a search query above.</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'network' && (
                        <div className="grid">
                            <div className="card col-span-12">
                                <div className="card-header">
                                    <h2 className="card-title">Mycelial Network Explorer</h2>
                                </div>
                                <div className="card-content">
                                    <div className="visualization-container" style={{ height: '600px' }}>
                                        <MycelialNetworkVisualization fullSize={true} />
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'console' && (
                        <div className="grid">
                            <div className="card col-span-12">
                                <div className="card-header">
                                    <h2 className="card-title">System Console</h2>
                                </div>
                                <div className="card-content">
                                    <div className="console" style={{ height: '600px' }}>
                                        {consoleMessages.map((msg, index) => (
                                            <div className="console-line" key={index}>
                                                <span className="timestamp">[{msg.timestamp}]</span>
                                                {msg.type === 'command' && <span className="command"> $ {msg.content}</span>}
                                                {msg.type === 'response' && <span className="response"> {msg.content}</span>}
                                                {msg.type === 'error' && <span className="error"> ! {msg.content}</span>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="footer">
                        <div>EVA & GUARANI BIOS-Q System - Version 7.5</div>
                        <div className="signature">✧༺❀༻∞ EVA & GUARANI ∞༺❀༻✧</div>
                    </footer>
                </div>
            );
        };

        // Mycelial Network Visualization Component using D3.js
        const MycelialNetworkVisualization = ({ fullSize = false }) => {
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (!containerRef.current) return;

                // Sample network data
                const nodes = [
                    { id: "BIOS-Q", group: 0, radius: 25 },

                    // Core systems
                    { id: "Mycelium", group: 1, radius: 20 },
                    { id: "Search", group: 1, radius: 20 },
                    { id: "Translation", group: 1, radius: 20 },
                    { id: "Monitoring", group: 1, radius: 20 },

                    // Subsystems
                    { id: "CRONOS", group: 2, radius: 18 },
                    { id: "ATLAS", group: 2, radius: 18 },
                    { id: "NEXUS", group: 2, radius: 18 },
                    { id: "ETHIK", group: 2, radius: 18 },

                    // Connected systems
                    { id: "Web", group: 3, radius: 15 },
                    { id: "Telegram", group: 3, radius: 15 },
                    { id: "API", group: 3, radius: 15 }
                ];

                const links = [
                    { source: "BIOS-Q", target: "Mycelium", value: 8 },
                    { source: "BIOS-Q", target: "Search", value: 8 },
                    { source: "BIOS-Q", target: "Translation", value: 8 },
                    { source: "BIOS-Q", target: "Monitoring", value: 8 },

                    { source: "Mycelium", target: "CRONOS", value: 5 },
                    { source: "Mycelium", target: "ATLAS", value: 5 },
                    { source: "Mycelium", target: "NEXUS", value: 5 },
                    { source: "Mycelium", target: "ETHIK", value: 5 },

                    { source: "Search", target: "ATLAS", value: 3 },
                    { source: "Translation", target: "NEXUS", value: 3 },
                    { source: "Monitoring", target: "CRONOS", value: 3 },

                    { source: "CRONOS", target: "NEXUS", value: 2 },
                    { source: "ATLAS", target: "ETHIK", value: 2 },
                    { source: "ATLAS", target: "NEXUS", value: 2 },

                    { source: "BIOS-Q", target: "API", value: 6 },
                    { source: "API", target: "Web", value: 4 },
                    { source: "API", target: "Telegram", value: 4 }
                ];

                // Clear previous visualization
                d3.select(containerRef.current).selectAll("*").remove();

                const width = containerRef.current.clientWidth;
                const height = containerRef.current.clientHeight;

                // Create SVG
                const svg = d3.select(containerRef.current)
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [0, 0, width, height]);

                // Define colors
                const color = d3.scaleOrdinal()
                    .domain([0, 1, 2, 3])
                    .range(["#8e44ad", "#3498db", "#2ecc71", "#e74c3c"]);

                // Create force simulation
                const simulation = d3.forceSimulation(nodes)
                    .force("link", d3.forceLink(links).id(d => d.id).distance(100))
                    .force("charge", d3.forceManyBody().strength(-300))
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("collide", d3.forceCollide().radius(d => d.radius * 1.5));

                // Create gradient for links
                const defs = svg.append("defs");

                links.forEach((link, i) => {
                    const gradient = defs.append("linearGradient")
                        .attr("id", `gradient-${i}`)
                        .attr("gradientUnits", "userSpaceOnUse");

                    const sourceNode = nodes.find(n => n.id === link.source || n.id === link.source.id);
                    const targetNode = nodes.find(n => n.id === link.target || n.id === link.target.id);

                    gradient.append("stop")
                        .attr("offset", "0%")
                        .attr("stop-color", color(sourceNode.group));

                    gradient.append("stop")
                        .attr("offset", "100%")
                        .attr("stop-color", color(targetNode.group));
                });

                // Create links
                const link = svg.append("g")
                    .selectAll("line")
                    .data(links)
                    .join("line")
                    .attr("stroke-width", d => Math.sqrt(d.value))
                    .attr("stroke", (d, i) => `url(#gradient-${i})`)
                    .attr("stroke-opacity", 0.6);

                // Create nodes
                const node = svg.append("g")
                    .selectAll("circle")
                    .data(nodes)
                    .join("circle")
                    .attr("r", d => d.radius)
                    .attr("fill", d => color(d.group))
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 1.5)
                    .call(drag(simulation));

                // Add labels
                const label = svg.append("g")
                    .selectAll("text")
                    .data(nodes)
                    .join("text")
                    .attr("text-anchor", "middle")
                    .attr("dy", 3)
                    .text(d => d.id)
                    .style("font-size", "10px")
                    .style("fill", "#fff")
                    .style("pointer-events", "none");

                // Update positions on simulation tick
                simulation.on("tick", () => {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("cx", d => d.x = Math.max(d.radius, Math.min(width - d.radius, d.x)))
                        .attr("cy", d => d.y = Math.max(d.radius, Math.min(height - d.radius, d.y)));

                    label
                        .attr("x", d => d.x)
                        .attr("y", d => d.y);
                });

                // Drag behavior
                function drag(simulation) {
                    function dragstarted(event) {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        event.subject.fx = event.subject.x;
                        event.subject.fy = event.subject.y;
                    }

                    function dragged(event) {
                        event.subject.fx = event.x;
                        event.subject.fy = event.y;
                    }

                    function dragended(event) {
                        if (!event.active) simulation.alphaTarget(0);
                        event.subject.fx = null;
                        event.subject.fy = null;
                    }

                    return d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended);
                }

                // Resize handler
                const handleResize = () => {
                    if (!containerRef.current) return;

                    const newWidth = containerRef.current.clientWidth;
                    const newHeight = containerRef.current.clientHeight;

                    svg.attr("width", newWidth)
                        .attr("height", newHeight)
                        .attr("viewBox", [0, 0, newWidth, newHeight]);

                    simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2))
                        .alpha(0.3)
                        .restart();
                };

                window.addEventListener("resize", handleResize);

                // Cleanup
                return () => {
                    window.removeEventListener("resize", handleResize);
                    simulation.stop();
                };
            }, [fullSize]);

            return <div ref={containerRef} style={{ width: '100%', height: '100%' }}></div>;
        };

        // Render the App
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>